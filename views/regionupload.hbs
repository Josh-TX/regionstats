{{#section 'styles'}}
{{/section}}
	{{>navigation_bar}}
	<div class="container" ng-controller="uploadRegion" ng-submit="submitForm()">
		<h1>Upload Region</h1>
		<form enctype="multipart/form-data" accept-charset="UTF-8">
			<div class="row top-buffer form-group" ng-class="{'has-error': error.parent}">
				<div class="col-sm-3">
					<button type="button" class="btn btn-primary btn-block" ng-click="regionModal.show=true">Select Parent Region</button>
				</div>
				<div class="col-sm-9">
					<input type="text" class="form-control" ng-model="regionModal.name" disabled></input>
					<span class="help-block pull-right" ng-bind="error.parent"></span>
				</div>
			</div>
			<div class="row top-buffer form-group" ng-class="{'has-error': error.type}">
				<div class="col-sm-3">
					<button type="button" class="btn btn-primary btn-block" ng-click="typeModal.show=true">Select Region Type</button>
				</div>
				<div class="col-sm-9">
					<input type="text" class="form-control" ng-model="typeModal.name" disabled></input>
					<span class="help-block pull-right" ng-bind="error.type"></span>
				</div>
			</div>
			<div class="row top-buffer form-group" ng-class="{'has-error': error.data}">
				<div class="col-sm-3">
					<label class="btn btn-primary btn-block">
						Select File 
						<input type="file" class="hidden" file-reader="form.data" file-name="fileName">
					</label>
				</div>
				<div class="col-sm-9">
					<input type="text" class="form-control" ng-model="fileName" disabled></input>
					<span class="help-block pull-right" ng-bind="error.data"></span>
				</div>
				
			</div>
			<input class="btn btn-primary btn-lg pull-right" type="submit" value="submit"></input>
		</form>
		<div ng-if="form.data.length > 0">
			<h2>preview</h2>
			<table>
				<tr>
					<th ng-bind="typeModal.name"></th>
				</tr>
				<tr ng-repeat="region in form.data track by $index">
					<td ng-bind="region"></td>
				</tr>
			</table>
		</div>
		<!-- modal -->
		<div modal="regionModal.show" str="regionModal.title" callback="regionModal.select(regionModal.currentRegion.id)">
			<h2 class="top-no-buffer"><small ng-bind="regionModal.currentRegion.name"></small></h2>
			<!--<input type="text" class="form-control" placeholder="filter"></input>-->
			<button ng-click="back()" ng-if="regionModal.list[regionModal.currentRegion.id].parent != -1">back</button>
			<hr>
			<button class="btn btn-default" ng-repeat="data in regionModal.list[regionModal.currentRegion.id].r" ng-click="regionModal.select(data.id)">{{ng "data.name"}}</button>
			<p ng-if="regionModal.list[regionModal.currentRegion.id].r.length == 0">No sub-regions found</p>
		</div>

		<div modal="typeModal.show" str="typeModal.title">
			<button class="btn btn-default" ng-repeat="(id, name) in typeModal.types" ng-click="typeModal.select(id)">{{ng "name"}}</button>
		</div>
	</div><!-- end container -->
	
{{#section 'scripts'}}

<script type="application/javascript">
    var app = angular.module("myApp", []);

	app.controller("uploadRegion", function($http, $scope){
		$scope.regionModal = {};
		$scope.regionModal.currentRegion = {id: 0, name: "World"};
		//$scope.regionModal.currentRegion.id = 1;
		//$scope.regionModal.currentRegion.name = "World";
		$scope.regionModal.list = {};
		$scope.regionModal.show = false;
		$scope.regionModal.title = "Select Parent Region";

		$http.post('/ajax/region', {id: $scope.regionModal.currentRegion.id}).then(successRegionCallback, errorRegionCallback);

		function getRegion(id)
		{
			if (!$scope.regionModal.list[id]){
				//console.log("getting region from server");	
				$http.post('/ajax/region', {id: $scope.regionModal.currentRegion.id}).then(successRegionCallback, errorRegionCallback);
			}
			else {
				var id = $scope.regionModal.currentRegion.id;
				$scope.regionModal.currentRegion.name = $scope.regionModal.list[id].name;
				$scope.regionModal.name = $scope.regionModal.currentRegion.name;
			}

			//the id has not been requested before, so do an SQL query and put it in regionList
		}

		$scope.back = function() {
			var id = $scope.regionModal.currentRegion.id;
			alert("ID: " + id);
			alert("Parent ID: " + $scope.regionModal.list[id].parent);
			$scope.regionModal.currentRegion.id = $scope.regionModal.list[id].parent;
			getRegion(id);
		}
		
		$scope.regionModal.name = "not selected";
		$scope.regionModal.select = function(id){
			//var region = $scope.regionModal.stack[$scope.regionModal.stack.length - 1];
			console.log(id);
			//$scope.form.parent = region.id;
			$scope.regionModal.currentRegion.id = id;
			getRegion(id);
		}

		function successRegionCallback(response)
		{
			//alert(response);
			console.log(response.data);
			var id = $scope.regionModal.currentRegion.id;
			$scope.regionModal.list[id] = response.data;
			$scope.regionModal.currentRegion.name = $scope.regionModal.list[id].name;
			$scope.regionModal.name = $scope.regionModal.currentRegion.name;
			//alert("Name: " + $scope.regionModal.name)
		}

		function errorRegionCallback(response)
		{
			//alert(response);
			console.log(response);
		}
	
		
		$scope.typeModal = {}
		$scope.typeModal.types = {
			"1": "Country",
			"2": "City",
			"3": "State"
		}
		$scope.typeModal.show = false;
		$scope.typeModal.title = "Select Region Type";
		$scope.typeModal.name = "not selected";
		$scope.typeModal.select = function(id){
			$scope.typeModal.name = this.types[id];
			$scope.form.type = id;
			$scope.typeModal.show = false;
		}
		
		$scope.form = {};
		$scope.fileName = "not selected";
		$scope.form.data = [];

		$scope.submitForm = function(){
			$scope.form.data.map(titleCase);
			$scope.error = uploadRegionValidate($scope.form);
			if ($scope.error.none)
				$http.post('/region/upload', $scope.form).then(successCallback, errorCallback);
		}
		
		function successCallback(response){
			if (response.data.redirect){
				window.location.href = response.data.redirect;
			}
			else if (response.data.message){
				alert(response.data.message)
			}
			else {
				alert("unknown response");
			}
		}
		
		function errorCallback(response){
			alert("an error occured: " + JSON.stringify(response.data))
		}
	});
</script>
<script src="/content/js/filereader.js"></script>
<script src="/content/js/modal.js"></script>
<script src="/content/js/titlecase.js"></script>
<script src="/content/validators/regionupload.js"></script>

{{/section}}